#!/usr/bin/env python3
import sys
import os
import json
import time
import requests
import zipfile
import io
import datetime

# --- CONFIGURATION ---
DB_PATH = os.path.expanduser("~/lyall-fix-assistant/installed_fixes.json")
UPDATE_COOLDOWN = 24

# ANSI Colors (for Terminal Output)
CYAN = "\033[96m"
RESET = "\033[0m"
# ---------------------

def log(message):
    """Writes colored text to stdout, but plain text to lyallfix.log."""
    
    # 1. Print to Console (Colored)
    # We replace the plain tag with the colored tag just for the print statement
    colored_msg = message.replace("[Lyall]", f"{CYAN}[Lyall]{RESET}")
    print(colored_msg)
    sys.stdout.flush()

    # 2. Write to File (Clean / No Color)
    try:
        log_path = os.path.expanduser("~/lyallfix.log")
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # We strip the timestamp logic if the message already has one, 
        # but here we just append the raw message.
        with open(log_path, "a") as f:
            f.write(f"[{timestamp}] {message}\n")
    except Exception:
        pass

def load_db():
    if os.path.exists(DB_PATH):
        try:
            with open(DB_PATH, 'r') as f:
                return json.load(f)
        except: pass
    return {}

def save_db(data):
    try:
        with open(DB_PATH, 'w') as f:
            json.dump(data, f, indent=4)
    except: pass

def get_smart_overrides(installed_files):
    overrides = []
    dll_map = {
        'dinput8.dll': 'dinput8=n,b',
        'winmm.dll':   'winmm=n,b',
        'dsound.dll':  'dsound=n,b',
        'version.dll': 'version=n,b',
        'winhttp.dll': 'winhttp=n,b',
        'xinput1_3.dll': 'xinput1_3=n,b'
    }
    for filename in installed_files:
        if filename.lower() in dll_map:
            overrides.append(dll_map[filename.lower()])
    return overrides

def silent_update(repo_name, game_path, state):
    try:
        api_url = f"https://codeberg.org/api/v1/repos/Lyall/{repo_name}/releases/latest"
        r = requests.get(api_url, timeout=5)
        if r.status_code != 200: return False
        
        release = r.json()
        latest_tag = release['tag_name']
        
        if state[repo_name].get('tag') == latest_tag:
            return False

        log(f"[Lyall] Update found for {repo_name}: {latest_tag}")
        asset = next((a for a in release['assets'] if a['name'].endswith('.zip')), None)
        if not asset: return False

        z = zipfile.ZipFile(io.BytesIO(requests.get(asset['browser_download_url']).content))
        files_extracted = []
        
        for f in z.namelist():
            if "EXTRACT_TO_GAME_FOLDER" in f or "__MACOSX" in f: continue
            files_extracted.append(f)
            z.extract(f, game_path)
            
        state[repo_name]['tag'] = latest_tag
        state[repo_name]['files'] = files_extracted
        return True
    except Exception as e:
        log(f"[Lyall] Update skipped (Error: {e})")
        return False

def main():
    log("\n--- New Session Started ---")
    current_dir = os.getcwd()
    log(f"[Lyall] Wrapper active. Game Dir: {current_dir}")
    
    db = load_db()
    target_repo = None
    target_data = None

    if db:
        for repo, data in db.items():
            if os.path.normpath(data['path']) == os.path.normpath(current_dir):
                target_repo = repo
                target_data = data
                break
    else:
        log(f"[Lyall] Warning: Database not found at {DB_PATH}")

    if target_repo and target_data:
        log(f"[Lyall] Identified game: {target_repo}")
        
        last_checked = target_data.get('last_checked', 0)
        now = time.time()
        
        if (now - last_checked) > (UPDATE_COOLDOWN * 3600):
            log("[Lyall] Checking for updates...")
            if silent_update(target_repo, current_dir, db):
                log(f"[Lyall] Applied update for {target_repo}.")
                target_data = db[target_repo]
            else:
                log("[Lyall] No updates found or check skipped.")
            db[target_repo]['last_checked'] = now
            save_db(db)
        else:
            log(f"[Lyall] Update cooldown active.")

        if 'files' in target_data:
            needed_overrides = get_smart_overrides(target_data['files'])
            if needed_overrides:
                current_env = os.environ.get("WINEDLLOVERRIDES", "")
                to_add = [ov for ov in needed_overrides if ov not in current_env]
                if to_add:
                    prefix = ";" if current_env and not current_env.endswith(";") else ""
                    new_env = current_env + prefix + ";".join(to_add)
                    os.environ["WINEDLLOVERRIDES"] = new_env
                    log(f"[Lyall] Injecting launch options: {new_env}")
                else:
                    log("[Lyall] Overrides already present.")
    else:
        log("[Lyall] No matching fix found in DB.")

    if len(sys.argv) > 1:
        log("[Lyall] Launching game...")
        sys.stdout.flush()
        try:
            os.execvp(sys.argv[1], sys.argv[1:])
        except OSError as e:
            log(f"[Lyall] CRITICAL: Failed to launch game: {e}")
            sys.exit(1)
    else:
        log("[Lyall] Error: No game command provided.")

if __name__ == "__main__":
    main()